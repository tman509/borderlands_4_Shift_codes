name: CI (Simple)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.11"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Test basic imports
        run: |
          python -c "
          print('Testing imports...')
          
          # Test main_improved.py import
          try:
              import importlib.util
              spec = importlib.util.spec_from_file_location('bot', 'main_improved.py')
              bot_module = importlib.util.module_from_spec(spec)
              spec.loader.exec_module(bot_module)
              print('✅ main_improved.py imported successfully')
          except Exception as e:
              print(f'❌ main_improved.py import failed: {e}')
              raise
          
          # Test health_check.py import
          try:
              spec = importlib.util.spec_from_file_location('health', 'health_check.py')
              health_module = importlib.util.module_from_spec(spec)
              spec.loader.exec_module(health_module)
              print('✅ health_check.py imported successfully')
          except Exception as e:
              print(f'❌ health_check.py import failed: {e}')
              raise
          
          # Test migrate_db.py import
          try:
              spec = importlib.util.spec_from_file_location('migrate', 'migrate_db.py')
              migrate_module = importlib.util.module_from_spec(spec)
              spec.loader.exec_module(migrate_module)
              print('✅ migrate_db.py imported successfully')
          except Exception as e:
              print(f'❌ migrate_db.py import failed: {e}')
              raise
          
          print('All imports successful!')
          "

      - name: Test database functionality
        run: |
          python -c "
          print('Testing database functionality...')
          
          from main_improved import init_db, code_exists, insert_codes_batch, get_stats, normalize_code
          import tempfile
          import os
          
          # Test with temporary database
          with tempfile.NamedTemporaryFile(suffix='.db', delete=False) as f:
              db_path = f.name
          
          try:
              # Test database initialization
              conn = init_db(db_path)
              print('✅ Database initialization successful')
              
              # Test code normalization
              normalized = normalize_code('ABCDE-FGHIJ-KLMNO-PQRST-UVWXY')
              assert normalized == 'ABCDEFGHIJKLMNOPQRSTUVWXY'
              print('✅ Code normalization working')
              
              # Test code existence check
              exists = code_exists(conn, 'TEST-CODE-12345')
              assert not exists
              print('✅ Code existence check working')
              
              # Test batch insert
              test_data = [
                  ('TEST-CODE-12345', 'TESTCODE12345', 'golden key', 'test', 'test context', '2024-01-01T00:00:00Z')
              ]
              insert_codes_batch(conn, test_data)
              print('✅ Batch insert working')
              
              # Test stats
              stats = get_stats(conn)
              assert stats['total_codes'] >= 1
              print('✅ Statistics collection working')
              
              conn.close()
              
          finally:
              if os.path.exists(db_path):
                  os.unlink(db_path)
          
          print('✅ All database tests passed')
          "

      - name: Test configuration validation
        run: |
          python -c "
          print('Testing configuration validation...')
          
          import os
          from main_improved import validate_config
          
          # Test with minimal valid config
          os.environ['HTML_SOURCES'] = 'https://example.com'
          os.environ['DISCORD_WEBHOOK_URL'] = 'https://discord.com/api/webhooks/test'
          
          try:
              validate_config()
              print('✅ Configuration validation working')
          except Exception as e:
              print(f'Configuration validation result: {e}')
              # Don't fail on config validation in CI
          
          print('✅ Configuration tests completed')
          "

      - name: Test health check functionality
        run: |
          python -c "
          print('Testing health check functionality...')
          
          from health_check import check_database, check_network, check_configuration
          import tempfile
          import os
          
          # Test database health check with temporary DB
          with tempfile.NamedTemporaryFile(suffix='.db', delete=False) as f:
              db_path = f.name
          
          try:
              # Initialize a test database
              from main_improved import init_db
              conn = init_db(db_path)
              conn.close()
              
              # Test database health check
              result = check_database(db_path)
              assert result['status'] in ['healthy', 'warning']
              print('✅ Database health check working')
              
          finally:
              if os.path.exists(db_path):
                  os.unlink(db_path)
          
          # Test network health check (may fail in CI, that's ok)
          try:
              result = check_network()
              print(f'Network check result: {result[\"status\"]}')
          except Exception as e:
              print(f'Network check failed (expected in CI): {e}')
          
          # Test configuration health check
          os.environ['HTML_SOURCES'] = 'https://example.com'
          result = check_configuration()
          assert result['status'] in ['healthy', 'warning']
          print('✅ Configuration health check working')
          
          print('✅ All health check tests passed')
          "

      - name: Test migration functionality
        run: |
          python -c "
          print('Testing migration functionality...')
          
          from migrate_db import migrate_database
          import tempfile
          import sqlite3
          import os
          
          # Create a legacy database structure
          with tempfile.NamedTemporaryFile(suffix='.db', delete=False) as f:
              db_path = f.name
          
          try:
              # Create old schema
              conn = sqlite3.connect(db_path)
              conn.execute('''
                  CREATE TABLE codes (
                      id INTEGER PRIMARY KEY AUTOINCREMENT,
                      code TEXT UNIQUE NOT NULL,
                      reward_type TEXT,
                      source TEXT,
                      context TEXT,
                      date_found_utc TEXT
                  )
              ''')
              conn.execute('INSERT INTO codes (code, reward_type, source, context, date_found_utc) VALUES (?, ?, ?, ?, ?)',
                          ('TEST-12345', 'golden key', 'test', 'test context', '2024-01-01T00:00:00Z'))
              conn.commit()
              conn.close()
              
              # Test migration
              migrate_database(db_path)
              print('✅ Database migration working')
              
              # Verify new schema
              conn = sqlite3.connect(db_path)
              cursor = conn.cursor()
              cursor.execute('PRAGMA table_info(codes)')
              columns = [col[1] for col in cursor.fetchall()]
              
              required_columns = ['normalized_code', 'expiry_date', 'is_active', 'created_at']
              for col in required_columns:
                  assert col in columns, f'Missing column: {col}'
              
              conn.close()
              print('✅ Migration schema verification passed')
              
          finally:
              if os.path.exists(db_path):
                  os.unlink(db_path)
          
          print('✅ All migration tests passed')
          "

  syntax-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check Python syntax
        run: |
          python -m py_compile main_improved.py
          python -m py_compile health_check.py
          python -m py_compile migrate_db.py
          echo "✅ All Python files have valid syntax"

  build-summary:
    runs-on: ubuntu-latest
    needs: [test, syntax-check]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## 🚀 CI Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Syntax Check | ${{ needs.syntax-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.test.result }}" == "success" && "${{ needs.syntax-check.result }}" == "success" ]]; then
            echo "✅ **All checks passed!** The code is ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Some checks failed.** Please review the results above." >> $GITHUB_STEP_SUMMARY
          fi